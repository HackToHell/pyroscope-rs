# frozen_string_literal: true

require 'rubygems/package_task'
require 'rake/extensiontask'
require_relative 'lib/pyroscope/version'

exec(*(["bundle", "exec", $PROGRAM_NAME] + ARGV)) if ENV['BUNDLE_GEMFILE'].nil?

begin
	Bundler.setup(:default, :development)
rescue Bundler::BundlerError => e
	$stderr.puts e.message
	$stderr.puts "Run `bundle install` to install missing gems"
	exit e.status_code
end

load File.expand_path('./ext/thread_id/Rakefile', __dir__)
load File.expand_path('./ext/rbspy/Rakefile', __dir__)

task default: %w[hello]

task :hello do
  puts 'Hello!'
end

spec = Bundler.load_gemspec('pyroscope.gemspec')

namespace :source do
  Gem::PackageTask.new(spec) do |pkg|
  end
end

namespace :x86_64_darwin do
  spec.platform = 'x86_64-darwin'
  spec.files += ['lib/rbspy/rbspy.bundle', 'lib/thread_id/thread_id.bundle']

  Gem::PackageTask.new(spec) do |pkg|
  end
end

namespace :arm64_darwin do
  spec.platform = 'arm64-darwin'
  spec.files += ['lib/rbspy/rbspy.bundle', 'lib/thread_id/thread_id.bundle']

  Gem::PackageTask.new(spec) do |pkg|
  end
end

namespace :x86_64_linux do
  spec.platform = 'x86_64-linux'
  spec.files += ['lib/rbspy/rbspy.bundle', 'lib/thread_id/thread_id.bundle']

  Gem::PackageTask.new(spec) do |pkg|
  end
end

namespace :aarch64_linux do
  spec.platform = 'aarch64-linux'
  spec.files += ['lib/rbspy/rbspy.bundle', 'lib/thread_id/thread_id.bundle']

  Gem::PackageTask.new(spec) do |pkg|
  end
end
